name: Run a reproducible build

on:
  ## NOTE: uncomment to run on all new tags automatically
  # push:
  #   tags:
  #     - "*"
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: 
    # NOTE: inputs only to build tags that don't have this github workflow already in it
    inputs:
      tag:
        type: choice
        description: Which tag to build
        required: false
        options:
          - 2018-07-25T1245-v1.0.0r1
          - 2018-07-25T1247-v1.0.0r1
          - 2018-07-25T1700-v1.0.0r1
          - 2018-08-07T1530-v1.0.0r2
          - 2018-09-05T1728-v1.0.1
          - 2018-09-11T1428-v1.0.2
          - 2018-11-26T1403-v1.1.0
          - 2019-04-09T1600-v2.0.2
          - 2019-04-25T1440-v2.0.3
          - 2019-05-13T1631-v2.0.4
          - 2019-06-26T1317-v2.1.0
          - 2019-07-03T1316-v2.1.1
          - 2019-08-02T1804-v2.1.2
          - 2019-09-06T1520-v2.1.3
          - 2019-09-11T1517-v2.1.4
          - 2019-09-17T1310-v2.1.5
          - 2019-10-08T1846-v2.1.6
          - 2019-10-09T1356-v3.0.0
          - 2019-10-10T1316-v3.0.1
          - 2019-11-01T1424-v3.0.2
          - 2019-11-06T1523-v3.0.3
          - 2019-11-25T1550-v3.0.5
          - 2019-12-19T1623-v3.0.6
          - 2020-02-20T1448-v3.1.0
          - 2020-02-26T1316-v3.1.1
          - 2020-02-27T1355-v3.1.2
          - 2020-04-30T1612-v3.1.3
          - 2020-06-12T1936-v3.1.4
          - 2020-06-13T1928-v3.1.5
          - 2020-06-14T1626-v3.1.6
          - 2020-08-04T1846-v3.1.8
          - 2020-08-06T1722-v3.1.9
          - 2020-11-23T1955-v3.2.0
          - 2021-01-07T1439-v3.2.1
          - 2021-01-14T1617-v3.2.2
          - 2021-03-12T1519-v4.0.0b2
          - 2021-03-15T1304-v4.0.0b3
          - 2021-03-15T1341-v4.0.0b3
          - 2021-03-17T1302-v4.0.0b4
          - 2021-03-17T1310-v4.0.0b4
          - 2021-03-17T1724-v4.0.0
          - 2021-03-29T1927-v4.0.1
          - 2021-04-07T1424-v4.0.2
          - 2021-04-29T1725-v4.1.0
          - 2021-04-30T1444-v4.1.1
          - 2021-04-30T1748-v4.1.1
          - 2021-07-28T1347-v4.1.2
          - 2021-09-02T1752-v4.1.3
          - 2022-01-17T1542-v5.0.0
          - 2022-03-09T1426-v5.0.0
          - 2022-03-09T1429-v5.0.0
          - 2022-03-14T1907-v5.0.0
          - 2022-03-24T1643-v5.0.1
          - 2022-03-24T1646-v5.0.1
          - 2022-04-19T1806-v5.0.2
          - 2022-04-25T1618-v4.1.4
          - 2022-05-04T1252-v5.0.3
          - 2022-05-04T1254-v5.0.3
          - 2022-05-04T1258-v4.1.5
          - 2022-05-27T1500-v5.0.4
          - 2022-07-20T1508-v5.0.5
          - 2022-07-29T1817-v5.0.6
          - 2022-10-05T1517-v4.1.6
          - 2022-10-05T1724-v5.0.7
          - 2022-11-14T1642-v4.1.7
          - 2022-11-14T1854-v4.1.7
          - 2023-02-27T1509-v5.1.0
          - 2023-02-27T2106-v5.1.1
          - 2023-04-07T1330-v5.1.2
          - 2023-05-12T1317-v6.0.0X
          - 2023-06-19T1540-v4.1.8
          - 2023-06-19T1627-v4.1.8
          - 2023-06-20T1506-v6.1.0X
          - bootloader-1.0.0
          - bootloader-1.0.1
          - bootloader-1.1.0
          - bootloader-1.2.0
          - bootloader-1.2.1
          - bootloader-2.0.0
          - bootloader-2.0.1
          - mk4-bootloader-3.0.0
          - mk4-bootloader-3.0.3
          - mk4-bootloader-3.1.1
          - mk4-bootloader-3.1.2
          - mk4-bootloader-3.1.3
          - mk4-bootloader-3.1.4
          - mk4-bootloader-3.1.5

jobs:
  repro:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Switch to tag
        if: ${{ github.event.inputs.tag }}
        run: git checkout ${{ github.event.inputs.tag }}

      - name: Run repro
        run: cd stm32 && make repro

